# i18n (FR/EN) Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add full French/English language support with a language selector, locale files, LLM integration, and translation workflow tools.

**Architecture:** react-i18next for language switching and interpolation. Domain-split JSON locale files (ui, game, soldiers, orders, achievements, 2IC, scenes). Scene `.ts` files keep game logic; translatable text extracted to JSON. LLM system prompt gets a `[LANGUAGE]` block for French generation.

**Tech Stack:** i18next, react-i18next, TypeScript, Vite, Vitest

**Base path:** `normandy-1944/` (relative to workspace root)

---

## Task 1: Install Dependencies & Create i18n Config

**Files:**
- Modify: `normandy-1944/package.json`
- Create: `normandy-1944/src/locales/i18n.ts`
- Create: `normandy-1944/src/locales/en/ui.json`
- Create: `normandy-1944/src/locales/fr/ui.json` (stub)
- Test: `normandy-1944/tests/i18n/i18n.test.ts`

**Step 1: Install i18next and react-i18next**

```bash
cd normandy-1944 && npm install i18next react-i18next
```

**Step 2: Create English UI locale file**

Create `src/locales/en/ui.json`:

```json
{
  "title": "Normandy 1944",
  "subtitle": "Night of June 5-6, 1944. You command 2nd Platoon, Easy Company, 506th Parachute Infantry Regiment, 101st Airborne Division. Your men are scattered across the Normandy countryside. The clock is ticking.",
  "beginOperation": "Begin Operation",
  "resetProgress": "Reset Progress",
  "resetConfirm": "Reset all progress? This clears lessons and achievements.",
  "aiNarrationActive": "AI Narration Active",
  "achievementCount": "{{count}} achievement",
  "achievementCount_other": "{{count}} achievements",
  "lessonCount": "{{count}} lesson",
  "lessonCount_other": "{{count}} lessons",
  "continue": "Continue...",
  "thinking": "Thinking...",
  "go": "Go",
  "orders": "Orders",
  "roster": "Roster",
  "wiki": "Wiki",
  "lessons": "Lessons",
  "menu": "Menu",
  "close": "ESC",
  "achievementUnlocked": "Achievement Unlocked",
  "afterTheWar": "After the War",
  "tryAgain": "Try Again",
  "beginAgain": "Begin Again",
  "yourPosition": "Your position:",
  "front": "Front",
  "middle": "Middle",
  "rear": "Rear",
  "freeTextPlaceholder": "Or describe what you do...",
  "platoonRoster": "Platoon Roster",
  "battleOrders": "Battle Orders",
  "fieldManual": "Field Manual",
  "lessonsLearned": "Lessons Learned",
  "killedInAction": "Killed in Action",
  "accessCodeLabel": "Access Code (optional — enables AI narration)",
  "accessCodePlaceholder": "Enter access code",
  "activate": "Activate",
  "validating": "Validating...",
  "accessCodeInvalid": "Invalid access code.",
  "accessCodeOffline": "Could not reach server. Playing in offline mode.",
  "noLessonsYet": "No lessons learned yet. Experience teaches — sometimes at a cost.",
  "lessonLearnedHeader": "Lesson Learned",
  "noWikiEntries": "No field manual entries available yet. Entries unlock as you encounter equipment, tactics, and units during operations.",
  "language": "Language",
  "english": "English",
  "french": "Français"
}
```

**Step 3: Create French UI locale stub**

Create `src/locales/fr/ui.json`:

```json
{
  "title": "Normandie 1944",
  "subtitle": "Nuit du 5 au 6 juin 1944. Vous commandez le 2e Platoon, Easy Company, 506th Parachute Infantry Regiment, 101st Airborne Division. Vos hommes sont dispersés dans la campagne normande. Le temps presse.",
  "beginOperation": "Commencer l'opération",
  "resetProgress": "Réinitialiser",
  "resetConfirm": "Réinitialiser toute la progression ? Les leçons et succès seront effacés.",
  "aiNarrationActive": "Narration IA active",
  "achievementCount_one": "{{count}} succès",
  "achievementCount_other": "{{count}} succès",
  "lessonCount_one": "{{count}} leçon",
  "lessonCount_other": "{{count}} leçons",
  "continue": "Continuer...",
  "thinking": "Réflexion...",
  "go": "Go",
  "orders": "Ordres",
  "roster": "Effectifs",
  "wiki": "Wiki",
  "lessons": "Leçons",
  "menu": "Menu",
  "close": "ESC",
  "achievementUnlocked": "Succès débloqué",
  "afterTheWar": "Après la guerre",
  "tryAgain": "Réessayer",
  "beginAgain": "Recommencer",
  "yourPosition": "Votre position :",
  "front": "Avant",
  "middle": "Centre",
  "rear": "Arrière",
  "freeTextPlaceholder": "Ou décrivez ce que vous faites...",
  "platoonRoster": "Effectifs du Platoon",
  "battleOrders": "Ordres de bataille",
  "fieldManual": "Manuel de campagne",
  "lessonsLearned": "Leçons apprises",
  "killedInAction": "Tué au combat",
  "accessCodeLabel": "Code d'accès (optionnel — active la narration IA)",
  "accessCodePlaceholder": "Entrez le code d'accès",
  "activate": "Activer",
  "validating": "Validation...",
  "accessCodeInvalid": "Code d'accès invalide.",
  "accessCodeOffline": "Impossible de contacter le serveur. Mode hors-ligne.",
  "noLessonsYet": "Aucune leçon apprise. L'expérience enseigne — parfois au prix fort.",
  "lessonLearnedHeader": "Leçon apprise",
  "noWikiEntries": "Aucune entrée disponible. Les entrées apparaissent lorsque vous rencontrez des équipements, tactiques et unités en opération.",
  "language": "Langue",
  "english": "English",
  "french": "Français"
}
```

**Step 4: Create i18n configuration**

Create `src/locales/i18n.ts`:

```typescript
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';

import enUi from './en/ui.json';
import frUi from './fr/ui.json';

const STORAGE_KEY = 'normandy1944_language';

function getDefaultLanguage(): string {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved === 'fr' || saved === 'en') return saved;
  return navigator.language.startsWith('fr') ? 'fr' : 'en';
}

i18n.use(initReactI18next).init({
  resources: {
    en: { ui: enUi },
    fr: { ui: frUi },
  },
  lng: getDefaultLanguage(),
  fallbackLng: 'en',
  interpolation: { escapeValue: false },
  defaultNS: 'ui',
});

export function setLanguage(lang: 'en' | 'fr'): void {
  localStorage.setItem(STORAGE_KEY, lang);
  i18n.changeLanguage(lang);
}

export function getLanguage(): 'en' | 'fr' {
  return (i18n.language as 'en' | 'fr') || 'en';
}

export default i18n;
```

**Step 5: Write the failing test**

Create `tests/i18n/i18n.test.ts`:

```typescript
import { describe, it, expect, beforeEach } from 'vitest';
import i18n, { setLanguage, getLanguage } from '../../src/locales/i18n';

describe('i18n configuration', () => {
  beforeEach(() => {
    localStorage.clear();
    i18n.changeLanguage('en');
  });

  it('defaults to English', () => {
    expect(getLanguage()).toBe('en');
  });

  it('translates UI keys in English', () => {
    expect(i18n.t('ui:beginOperation')).toBe('Begin Operation');
  });

  it('translates UI keys in French', () => {
    setLanguage('fr');
    expect(i18n.t('ui:beginOperation')).toBe("Commencer l'opération");
  });

  it('falls back to English for missing French keys', () => {
    setLanguage('fr');
    // If a key is missing in French, English shows
    expect(i18n.t('ui:title')).toBe('Normandie 1944');
  });

  it('persists language choice', () => {
    setLanguage('fr');
    expect(localStorage.getItem('normandy1944_language')).toBe('fr');
  });

  it('switches language and updates translations', () => {
    expect(i18n.t('ui:orders')).toBe('Orders');
    setLanguage('fr');
    expect(i18n.t('ui:orders')).toBe('Ordres');
    setLanguage('en');
    expect(i18n.t('ui:orders')).toBe('Orders');
  });
});
```

**Step 6: Run test to verify**

```bash
cd normandy-1944 && npx vitest run tests/i18n/i18n.test.ts
```

Expected: PASS (all 6 tests)

**Step 7: Commit**

```bash
git add -A && git commit -m "feat(i18n): install i18next, create locale files and config"
```

---

## Task 2: Create English Game Mechanics Locale File

**Files:**
- Create: `normandy-1944/src/locales/en/game.json`
- Create: `normandy-1944/src/locales/fr/game.json`
- Modify: `normandy-1944/src/locales/i18n.ts` (register namespace)

**Step 1: Create `src/locales/en/game.json`**

```json
{
  "status": {
    "men": "Men",
    "ammo": "Ammo",
    "morale": "Morale",
    "enemy": "Enemy",
    "alone": "ALONE",
    "timeUnit": "hrs"
  },
  "alertStatus": {
    "confused": "CONFUSED",
    "alerted": "ALERTED",
    "organized": "ORGANIZED",
    "fortified": "FORTIFIED"
  },
  "soldierStatus": {
    "active": "Active",
    "wounded": "Wounded",
    "KIA": "KIA",
    "missing": "Missing"
  },
  "milestoneStatus": {
    "achieved": "✓",
    "pending": "—",
    "missed": "MISSED"
  },
  "phase": {
    "solo": "Solo",
    "squad": "Squad",
    "platoon": "Platoon"
  }
}
```

**Step 2: Create `src/locales/fr/game.json`**

```json
{
  "status": {
    "men": "Hommes",
    "ammo": "Munitions",
    "morale": "Moral",
    "enemy": "Ennemi",
    "alone": "SEUL",
    "timeUnit": "h"
  },
  "alertStatus": {
    "confused": "CONFUS",
    "alerted": "EN ALERTE",
    "organized": "ORGANISÉ",
    "fortified": "FORTIFIÉ"
  },
  "soldierStatus": {
    "active": "Actif",
    "wounded": "Blessé",
    "KIA": "KIA",
    "missing": "Disparu"
  },
  "milestoneStatus": {
    "achieved": "✓",
    "pending": "—",
    "missed": "MANQUÉ"
  },
  "phase": {
    "solo": "Solo",
    "squad": "Escouade",
    "platoon": "Section"
  }
}
```

**Step 3: Register namespace in i18n.ts**

Add to `src/locales/i18n.ts`:

```typescript
import enGame from './en/game.json';
import frGame from './fr/game.json';

// In resources:
resources: {
  en: { ui: enUi, game: enGame },
  fr: { ui: frUi, game: frGame },
},
```

**Step 4: Commit**

```bash
git add -A && git commit -m "feat(i18n): add game mechanics locale files"
```

---

## Task 3: Language Selector Component + App Integration

**Files:**
- Create: `normandy-1944/src/components/LanguageSelector.tsx`
- Modify: `normandy-1944/src/App.tsx` (import i18n)
- Modify: `normandy-1944/src/components/MainMenu.tsx` (add selector)
- Modify: `normandy-1944/src/styles/game.css` (language selector styles)
- Test: `normandy-1944/tests/i18n/i18n.test.ts` (extend)

**Step 1: Create LanguageSelector component**

Create `src/components/LanguageSelector.tsx`:

```tsx
import { useTranslation } from 'react-i18next';
import { setLanguage } from '../locales/i18n';

export default function LanguageSelector() {
  const { i18n } = useTranslation();
  const current = i18n.language;

  return (
    <div className="language-selector" data-testid="language-selector">
      <button
        className={`language-selector__btn${current === 'en' ? ' language-selector__btn--active' : ''}`}
        data-testid="language-en"
        onClick={() => setLanguage('en')}
      >
        English
      </button>
      <button
        className={`language-selector__btn${current === 'fr' ? ' language-selector__btn--active' : ''}`}
        data-testid="language-fr"
        onClick={() => setLanguage('fr')}
      >
        Français
      </button>
    </div>
  );
}
```

**Step 2: Import i18n in App.tsx entry point**

Add to the TOP of `src/App.tsx` (before other imports):

```typescript
import './locales/i18n';
```

This initializes i18next before any component renders. No provider wrapper needed — `react-i18next` v14+ uses a shared instance.

**Step 3: Add LanguageSelector to MainMenu**

Modify `src/components/MainMenu.tsx`:
- Add import: `import LanguageSelector from './LanguageSelector';`
- Add `<LanguageSelector />` just before the title `<h1>` element

**Step 4: Add CSS styles**

Add to `src/styles/game.css`:

```css
/* Language selector */
.language-selector {
  display: flex;
  justify-content: center;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
}

.language-selector__btn {
  background: transparent;
  border: 1px solid var(--text-muted);
  color: var(--text-muted);
  padding: 0.3rem 1rem;
  cursor: pointer;
  font-family: var(--font-ui);
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  transition: all 0.2s ease;
}

.language-selector__btn:hover {
  color: var(--text-primary);
  border-color: var(--text-primary);
}

.language-selector__btn--active {
  color: var(--text-primary);
  border-color: var(--accent);
  background: rgba(255, 255, 255, 0.05);
}
```

**Step 5: Commit**

```bash
git add -A && git commit -m "feat(i18n): add language selector component and App integration"
```

---

## Task 4: Migrate UI Components to Translations

**Files:**
- Modify: `normandy-1944/src/components/MainMenu.tsx`
- Modify: `normandy-1944/src/components/StatusPanel.tsx`
- Modify: `normandy-1944/src/components/DecisionPanel.tsx`
- Modify: `normandy-1944/src/components/OrdersPanel.tsx`
- Modify: `normandy-1944/src/components/RosterPanel.tsx`
- Modify: `normandy-1944/src/components/LessonJournal.tsx`
- Modify: `normandy-1944/src/components/WikiPanel.tsx`
- Modify: `normandy-1944/src/components/AchievementPopup.tsx`
- Modify: `normandy-1944/src/components/DeathReport.tsx`
- Modify: `normandy-1944/src/components/EpilogueScreen.tsx`
- Modify: `normandy-1944/src/components/AccessCodeInput.tsx`
- Modify: `normandy-1944/src/components/FreeTextInput.tsx`
- Modify: `normandy-1944/src/components/GameScreen.tsx`
- Modify: `normandy-1944/src/components/NarrativePanel.tsx`

This is the largest task. Each component gets `useTranslation` and replaces hardcoded strings with `t()` calls.

**Step 1: Migrate MainMenu.tsx**

Replace every hardcoded string with a `t()` call:

```tsx
import { useTranslation } from 'react-i18next';

// Inside the component:
const { t } = useTranslation('ui');

// Replace:
//   "Normandy 1944"                    → t('title')
//   "Night of June 5-6..."             → t('subtitle')
//   "AI Narration Active"              → t('aiNarrationActive')
//   "Begin Operation"                  → t('beginOperation')
//   "Reset Progress"                   → t('resetProgress')
//   "Reset all progress?..."           → t('resetConfirm')
//   achievements count text            → t('achievementCount', { count }) + ' · ' + t('lessonCount', { count })
```

**Step 2: Migrate StatusPanel.tsx**

```tsx
import { useTranslation } from 'react-i18next';

const { t } = useTranslation('game');

// Replace:
//   "Men"          → t('status.men')
//   "Ammo"         → t('status.ammo')
//   "Morale"       → t('status.morale')
//   "Enemy"        → t('status.enemy')
//   "ALONE"        → t('status.alone')
//   "hrs"          → t('status.timeUnit')
//   alertStatus    → t(`alertStatus.${alertStatus.toLowerCase()}`)
```

Note: `getAlertStatus()` currently returns English strings like "CONFUSED". Change the component to use the readiness number directly and look up the translated string via locale key. The `getAlertStatus` function in `gameState.ts` returns a key-friendly string; the component translates it.

**Step 3: Migrate DecisionPanel.tsx**

```tsx
import { useTranslation } from 'react-i18next';

const { t } = useTranslation('ui');

// Replace:
//   "Your position:" → t('yourPosition')
//   "front"          → t('front')
//   "middle"         → t('middle')
//   "rear"           → t('rear')
```

The position buttons currently render `{pos}` directly. Change to `{t(pos)}` where `pos` is "front"/"middle"/"rear" and the locale has matching keys.

**Step 4: Migrate remaining components**

Each component follows the same pattern: add `useTranslation`, replace hardcoded strings. Key replacements:

| Component | Strings to replace |
|-----------|-------------------|
| `OrdersPanel.tsx` | Title "Battle Orders", milestone status labels, OPORD text |
| `RosterPanel.tsx` | Title "Platoon Roster", column headers, status labels |
| `LessonJournal.tsx` | Title "Lessons Learned", empty state text |
| `WikiPanel.tsx` | Title "Field Manual", empty state text |
| `AchievementPopup.tsx` | "Achievement Unlocked" text |
| `DeathReport.tsx` | "Killed in Action", "Try Again", "After the War" buttons |
| `EpilogueScreen.tsx` | "After the War" header, "Begin Again" button, memorial text |
| `AccessCodeInput.tsx` | Label, placeholder, button text, error messages |
| `FreeTextInput.tsx` | Placeholder text, submit button |
| `GameScreen.tsx` | Toolbar button labels ("Orders", "Roster", "Wiki", "Lessons"), "Continue..." button |
| `NarrativePanel.tsx` | Loading indicator text "..." → t('thinking') |

**Step 5: Run existing tests**

```bash
cd normandy-1944 && npx vitest run
```

Expected: All existing tests pass (components still render the same text via fallback English).

**Step 6: Commit**

```bash
git add -A && git commit -m "feat(i18n): migrate all UI components to useTranslation"
```

---

## Task 5: Extract Scene Content to Locale Files

**Files:**
- Create: `normandy-1944/src/locales/en/scenes/act1_scene01.json` (and 02-07)
- Create: `normandy-1944/src/locales/fr/scenes/` (empty stubs for each)
- Modify: `normandy-1944/src/locales/i18n.ts` (register scene namespaces)

**Step 1: Extract scene text to locale JSON**

For each scene file (`scene01_landing.ts` through `scene07_the_road.ts`), create a JSON file containing:
- `narrative`: the scene's main narrative text
- `narrativeAlt`: keyed alternate narratives (if any)
- `decisions.{id}.text`: each decision's button text
- `decisions.{id}.success`: success outcome text
- `decisions.{id}.partial`: partial outcome text
- `decisions.{id}.failure`: failure outcome text

Example for `src/locales/en/scenes/act1_scene01.json`:

```json
{
  "narrative": "You're waist-deep in black water. The parachute drags behind you, rigging lines knotted around your legs. No moon, no stars — just the distant pulse of anti-aircraft fire along the horizon. Your rifle is somewhere under the surface. The pistol is still on your hip. You are alone in occupied France.",
  "narrativeAlt": {
    "assess_before_acting": "You're waist-deep in black water. The parachute drags behind you, rigging lines knotted around your legs. No moon, no stars — just the distant pulse of anti-aircraft fire along the horizon. Your rifle is somewhere under the surface. The pistol is still on your hip. You've done this before. Slow down. Think first."
  },
  "decisions": {
    "landing_check_gear": {
      "text": "Check your gear — pat down every pocket, check each strap",
      "success": "You work your pockets methodically. Pistol, two grenades, cricket clicker — all accounted for. Your fingers close around the compass in your trouser pocket. The luminous dial glows faint green.",
      "partial": "Your hands are numb. You find the pistol, feel two grenades, but your fingers won't cooperate for anything smaller. You need dry ground before you can do a proper check.",
      "failure": "You fumble with your harness. Something falls from the webbing — a small splash, then nothing. Your fingers search the water but it's gone. The cold is winning."
    },
    "landing_assess": {
      "text": "Get your bearings — listen, look for any light or landmark",
      "success": "...",
      "partial": "...",
      "failure": "..."
    }
  }
}
```

Do this for ALL 7 scene files. Extract the exact text from each scene `.ts` file.

**Step 2: Create empty French scene stubs**

For each English scene file, create a matching `fr/scenes/` file with the same structure but empty strings:

```json
{
  "narrative": "",
  "decisions": {
    "landing_check_gear": {
      "text": "",
      "success": "",
      "partial": "",
      "failure": ""
    }
  }
}
```

This ensures the key structure exists. Empty strings will fall back to English via i18next.

Actually — better approach: DON'T create empty French stubs. i18next falls back to English when the French file doesn't exist. Create French scene files only when actual translations are ready. The `i18n:status` script will detect missing files.

**Step 3: Register scene namespaces in i18n.ts**

Two approaches:
- **Option A**: One namespace per scene (7 separate JSON imports). Granular but verbose.
- **Option B**: One `scenes` namespace that merges all scene JSON files with scene ID as top-level key.

Choose **Option B** — one `scenes` namespace:

```typescript
// In i18n.ts
import enScene01 from './en/scenes/act1_scene01.json';
import enScene02 from './en/scenes/act1_scene02.json';
// ... etc

const enScenes = {
  act1_landing: enScene01,
  act1_finding_north: enScene02,
  act1_first_contact: enScene03,
  act1_the_sergeant: enScene04,
  act1_the_patrol: enScene05,
  act1_the_farmhouse: enScene06,
  act1_the_road: enScene07,
};

// In resources:
resources: {
  en: { ui: enUi, game: enGame, scenes: enScenes },
  fr: { ui: frUi, game: frGame },  // no fr scenes yet = falls back to en
},
```

The scene key matches the scene's `id` field from the `.ts` file (e.g., `"act1_landing"`).

**Step 4: Commit**

```bash
git add -A && git commit -m "feat(i18n): extract scene content to English locale files"
```

---

## Task 6: Integrate Scene Locale Files with Rendering

**Files:**
- Modify: `normandy-1944/src/components/GameScreen.tsx`
- Modify: `normandy-1944/src/components/NarrativePanel.tsx`
- Modify: `normandy-1944/src/components/DecisionPanel.tsx`

**Step 1: Modify GameScreen to resolve narrative from locale**

Currently `GameScreen` reads `scene.narrative` directly. Change to:

```tsx
import { useTranslation } from 'react-i18next';

// Inside component:
const { t } = useTranslation('scenes');

// When setting scene narrative:
const sceneId = gameState.currentScene;  // e.g. "act1_landing"

// Check for narrativeAlt first (lesson-based alternate)
let narrativeKey = `${sceneId}.narrative`;
if (scene?.narrativeAlt) {
  for (const [lessonId, _altText] of Object.entries(scene.narrativeAlt)) {
    if (gameState.lessonsUnlocked.includes(lessonId)) {
      narrativeKey = `${sceneId}.narrativeAlt.${lessonId}`;
      break;
    }
  }
}
const localizedNarrative = t(narrativeKey, { defaultValue: scene?.narrative ?? '' });
```

For outcome text:
```tsx
// After determining outcomeTier and decision:
const outcomeKey = `${sceneId}.decisions.${decision.id}.${outcomeTier}`;
const localizedOutcome = t(outcomeKey, { defaultValue: outcome.text });
```

The `defaultValue` ensures fallback to the hardcoded text if the locale key doesn't exist.

**Step 2: Modify DecisionPanel to resolve decision text from locale**

```tsx
import { useTranslation } from 'react-i18next';

// Inside component, add a sceneId prop:
interface DecisionPanelProps {
  sceneId: string;  // NEW
  // ... existing props
}

const { t } = useTranslation('scenes');

// In the decision button:
{t(`${sceneId}.decisions.${d.id}.text`, { defaultValue: d.text })}
```

**Step 3: Pass sceneId through from GameScreen to DecisionPanel**

Add `sceneId={gameState.currentScene}` prop to the DecisionPanel in GameScreen.

**Step 4: Run tests**

```bash
cd normandy-1944 && npx vitest run
```

Expected: All tests pass. The game renders the same text as before (English locale keys match hardcoded text).

**Step 5: Commit**

```bash
git add -A && git commit -m "feat(i18n): integrate scene locale files with rendering components"
```

---

## Task 7: Extract Remaining Content to Locale Files

**Files:**
- Create: `normandy-1944/src/locales/en/soldiers.json`
- Create: `normandy-1944/src/locales/en/orders.json`
- Create: `normandy-1944/src/locales/en/achievements.json`
- Create: `normandy-1944/src/locales/en/secondInCommand.json`
- Create: `normandy-1944/src/locales/fr/soldiers.json` (stub with key structure)
- Create: `normandy-1944/src/locales/fr/orders.json`
- Create: `normandy-1944/src/locales/fr/achievements.json`
- Create: `normandy-1944/src/locales/fr/secondInCommand.json`
- Modify: `normandy-1944/src/locales/i18n.ts` (register namespaces)

**Step 1: Create `en/soldiers.json`**

Extract from `roster.ts`. Each soldier keyed by ID:

```json
{
  "henderson": {
    "background": "Former factory foreman. Oldest man in the platoon.",
    "epilogue": {
      "active": "survived the war. Promoted to First Sergeant after Bastogne. Bronze Star. Returned to Scranton, married Margaret, ran a plumbing supply company. Died 2001, age 78.",
      "wounded": "evacuated after taking shrapnel. Four months in an English hospital. Walked with a limp. Became a foreman again in Scranton. Died 1998.",
      "KIA": "killed in action near Sainte-Marie-du-Mont, June 6, 1944. Age 28. Normandy American Cemetery, Colleville-sur-Mer.",
      "missing": "captured. Eleven months in Stalag VII-A. Liberated April 1945. Returned to Scranton. Never spoke about the camp."
    }
  },
  "malone": {
    "background": "Ex-boxer, built like a fire hydrant. Leads from the front.",
    "epilogue": {
      "active": "...",
      "wounded": "...",
      "KIA": "...",
      "missing": "..."
    }
  }
}
```

Repeat for all 18 soldiers. Extract backgrounds from `roster.ts` and epilogue templates from `EpilogueScreen.tsx`.

**Step 2: Create `en/orders.json`**

Extract from `battleOrders.ts`:

```json
{
  "opord": "OPERATION ALBANY — 506th PIR, 2nd PLATOON, EASY COMPANY\nCLASSIFICATION: SECRET\nDATE: 5 JUNE 1944\n\nMISSION: Secure causeway exit at Sainte-Marie-du-Mont to enable linkup with seaborne forces landing Utah Beach at H-Hour.\n\nTIMELINE:\n  0100 — Drop on DZ C. Rally at assembly area.\n  0400 — Assembly complete. Move to objective area.\n  0600 — H-HOUR. Beach landings begin.\n  0900 — Crossroads SECURED. Establish defensive perimeter.\n  1200 — Resupply expected from beach elements.\n  1800 — Relief expected from 4th Infantry Division.\n  0100 — End of operational period.",
  "milestones": {
    "drop": "Drop on DZ C. Rally at assembly area.",
    "rally_complete": "Assembly complete. Move to objective area.",
    "h_hour": "H-HOUR. Beach landings begin.",
    "crossroads_secured": "Crossroads SECURED. Establish defensive perimeter.",
    "resupply": "Resupply expected from beach elements. Ensure position is secure.",
    "relief": "Relief expected from 4th Infantry Division. Maintain position.",
    "end_operational_period": "End of operational period."
  }
}
```

**Step 3: Create `en/achievements.json`**

Extract from `achievementTracker.ts`:

```json
{
  "first_drop": {
    "title": "First Drop",
    "description": "Complete your first playthrough (win or lose)."
  },
  "lessons_of_war": {
    "title": "Lessons of War",
    "description": "Unlock your first lesson."
  },
  "rally_point": {
    "title": "Rally Point",
    "description": "Find and rally 10 or more men in Act 1."
  }
}
```

Continue for all 16 achievements.

**Step 4: Create `en/secondInCommand.json`**

Extract 2IC comments from `scenarioLoader.ts`:

```json
{
  "veteran": {
    "low_ammo": "Captain, we're burning through ammo. Might want to think about conserving for the objective.",
    "low_morale": "The men are shaky, Captain. They need a win.",
    "low_men": "We don't have the numbers for this, sir.",
    "high_readiness": "They're dug in. This won't be easy.",
    "time_pressure": "Sir, we need to be at the objective. Clock's ticking.",
    "time_surplus": "We're ahead of schedule. Could use the time to scout the approach.",
    "bad_decision_reckless": "Sir, I'd reconsider. That's risky.",
    "bad_decision_suicidal": "With all due respect, sir — that's suicide."
  },
  "green": {
    "low_ammo": "Uh... we don't have a lot of bullets, sir.",
    "low_morale": "The guys seem... scared.",
    "low_men": "There's... not many of us, Captain.",
    "high_readiness": "They look ready for us.",
    "time_pressure": "",
    "time_surplus": "What do we do now, sir?",
    "bad_decision_reckless": "Yes sir, whatever you say.",
    "bad_decision_suicidal": "Yes sir, whatever you say."
  }
}
```

**Step 5: Create French stubs for all files**

Create `fr/soldiers.json`, `fr/orders.json`, `fr/achievements.json`, `fr/secondInCommand.json` with the same key structure but French content where straightforward (OPORD, achievement titles/descriptions). Leave complex narrative content empty (falls back to English).

**Step 6: Register all namespaces in i18n.ts**

```typescript
import enSoldiers from './en/soldiers.json';
import enOrders from './en/orders.json';
import enAchievements from './en/achievements.json';
import enSecondInCommand from './en/secondInCommand.json';
import frSoldiers from './fr/soldiers.json';
import frOrders from './fr/orders.json';
import frAchievements from './fr/achievements.json';
import frSecondInCommand from './fr/secondInCommand.json';

// resources:
en: { ui: enUi, game: enGame, scenes: enScenes, soldiers: enSoldiers, orders: enOrders, achievements: enAchievements, secondInCommand: enSecondInCommand },
fr: { ui: frUi, game: frGame, soldiers: frSoldiers, orders: frOrders, achievements: frAchievements, secondInCommand: frSecondInCommand },
```

**Step 7: Update components to use content locale files**

- `OrdersPanel.tsx`: Use `t('orders:milestones.{id}')` for milestone descriptions
- `AchievementPopup.tsx`: Use `t('achievements:{id}.title')` and `t('achievements:{id}.description')`
- `EpilogueScreen.tsx`: Use `t('soldiers:{id}.epilogue.{status}')` for epilogue templates
- `RosterPanel.tsx`: Use `t('soldiers:{id}.background')` for soldier backgrounds
- `scenarioLoader.ts` or the component that renders 2IC comments: Use `t('secondInCommand:veteran.{trigger}')` or `t('secondInCommand:green.{trigger}')`

**Step 8: Run tests**

```bash
cd normandy-1944 && npx vitest run
```

**Step 9: Commit**

```bash
git add -A && git commit -m "feat(i18n): extract soldiers, orders, achievements, 2IC to locale files"
```

---

## Task 8: Integrate Language with LLM Narrative Service

**Files:**
- Modify: `normandy-1944/src/services/promptBuilder.ts`
- Modify: `normandy-1944/src/services/narrativeService.ts`
- Test: `normandy-1944/tests/services/promptBuilder.test.ts` (extend)

**Step 1: Add language parameter to prompt builder**

In `src/services/promptBuilder.ts`:

```typescript
import { getLanguage } from '../locales/i18n';

const FRENCH_LANGUAGE_BLOCK = `
[LANGUAGE]
Generate all narrative text in French.
Maintain the same terse military tone — short sentences, present tense, second person ("vous").
Keep these terms in English: all soldier names, ranks (SSgt, Sgt, Cpl, PFC, Pvt), weapon names (BAR, MG-42, Gammon bomb), acronyms (OPORD, DZ, PIR, KIA), location names (Sainte-Marie-du-Mont, Utah Beach).
Use "h" for time (e.g., "0215 h" not "0215 hrs").
`;

// In buildNarrationPrompt:
export function buildNarrationPrompt(input: NarrationPromptInput): PromptPair {
  const language = getLanguage();
  let system = /* existing system prompt */;
  
  if (language === 'fr') {
    system += FRENCH_LANGUAGE_BLOCK;
  }
  
  return { system, userMessage: /* existing */ };
}
```

Apply the same pattern to `buildClassificationPrompt` (classification stays English internally — only narration output changes), `buildEpiloguePrompt` (epilogues generate in the player's language), and `buildRallyPrompt`.

**Step 2: Pass language in narrative service API calls**

In `src/services/narrativeService.ts`, include `language` in the request body sent to the Cloudflare Worker:

```typescript
const response = await fetch(`${this.apiUrl}/api/narrative`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${this.accessCode}`,
  },
  body: JSON.stringify({
    ...existingPayload,
    language: getLanguage(),
  }),
});
```

**Step 3: Write tests**

In `tests/services/promptBuilder.test.ts`, add:

```typescript
describe('language integration', () => {
  it('adds French language block when language is fr', () => {
    // Mock getLanguage to return 'fr'
    // Build narration prompt
    // Assert system prompt contains FRENCH_LANGUAGE_BLOCK
  });

  it('does not add language block for English', () => {
    // Mock getLanguage to return 'en'
    // Build narration prompt  
    // Assert system prompt does NOT contain [LANGUAGE]
  });

  it('epilogue prompt includes French block', () => {
    // Mock getLanguage to return 'fr'
    // Build epilogue prompt
    // Assert system prompt contains FRENCH_LANGUAGE_BLOCK
  });
});
```

**Step 4: Run tests**

```bash
cd normandy-1944 && npx vitest run
```

**Step 5: Commit**

```bash
git add -A && git commit -m "feat(i18n): integrate language with LLM narrative and prompt builder"
```

---

## Task 9: Translation Status Script

**Files:**
- Create: `normandy-1944/scripts/i18n-status.ts`
- Modify: `normandy-1944/package.json` (add script)

**Step 1: Create the status script**

Create `scripts/i18n-status.ts`:

```typescript
import * as fs from 'fs';
import * as path from 'path';

const LOCALES_DIR = path.resolve(__dirname, '../src/locales');
const SOURCE_LANG = 'en';
const TARGET_LANG = 'fr';

function countKeys(obj: Record<string, unknown>, prefix = ''): string[] {
  const keys: string[] = [];
  for (const [key, value] of Object.entries(obj)) {
    const fullKey = prefix ? `${prefix}.${key}` : key;
    if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
      keys.push(...countKeys(value as Record<string, unknown>, fullKey));
    } else {
      keys.push(fullKey);
    }
  }
  return keys;
}

function getJsonFiles(dir: string): string[] {
  const files: string[] = [];
  if (!fs.existsSync(dir)) return files;
  for (const entry of fs.readdirSync(dir, { withFileTypes: true })) {
    if (entry.isDirectory()) {
      files.push(...getJsonFiles(path.join(dir, entry.name)));
    } else if (entry.name.endsWith('.json')) {
      files.push(path.join(dir, entry.name));
    }
  }
  return files;
}

const enDir = path.join(LOCALES_DIR, SOURCE_LANG);
const frDir = path.join(LOCALES_DIR, TARGET_LANG);
const enFiles = getJsonFiles(enDir);

let totalEn = 0;
let totalFr = 0;

console.log(`\nTranslation status (${SOURCE_LANG} → ${TARGET_LANG}):\n`);

for (const enFile of enFiles) {
  const relativePath = path.relative(enDir, enFile);
  const frFile = path.join(frDir, relativePath);

  const enData = JSON.parse(fs.readFileSync(enFile, 'utf-8'));
  const enKeys = countKeys(enData);

  let frKeys: string[] = [];
  let frTranslated = 0;

  if (fs.existsSync(frFile)) {
    const frData = JSON.parse(fs.readFileSync(frFile, 'utf-8'));
    frKeys = countKeys(frData);
    frTranslated = frKeys.filter(k => {
      const value = k.split('.').reduce((obj: any, key) => obj?.[key], frData);
      return typeof value === 'string' && value.length > 0;
    }).length;
  }

  const pct = enKeys.length > 0 ? Math.round((frTranslated / enKeys.length) * 100) : 0;
  const bar = '█'.repeat(Math.round(pct / 10)) + '░'.repeat(10 - Math.round(pct / 10));

  console.log(`  ${relativePath.padEnd(30)} ${bar} ${String(pct).padStart(3)}%  (${frTranslated}/${enKeys.length})`);

  totalEn += enKeys.length;
  totalFr += frTranslated;
}

const totalPct = totalEn > 0 ? Math.round((totalFr / totalEn) * 100) : 0;
console.log(`\n  ${'Overall'.padEnd(30)} ${totalPct}% complete (${totalFr}/${totalEn} keys)\n`);
```

**Step 2: Add npm script**

In `package.json`, add to scripts:

```json
"i18n:status": "npx tsx scripts/i18n-status.ts"
```

**Step 3: Test**

```bash
cd normandy-1944 && npm run i18n:status
```

Expected: Shows progress bars for each locale file.

**Step 4: Commit**

```bash
git add -A && git commit -m "feat(i18n): add translation status tracking script"
```

---

## Task 10: Translation Draft Generation Script

**Files:**
- Create: `normandy-1944/scripts/translate-draft.ts`
- Modify: `normandy-1944/package.json` (add script)

**Step 1: Create the draft generation script**

Create `scripts/translate-draft.ts`:

This script reads English locale files, identifies untranslated keys in French files, and generates French translations using the LLM (via the Cloudflare Worker or a direct API call with a user-provided key).

```typescript
import * as fs from 'fs';
import * as path from 'path';

const LOCALES_DIR = path.resolve(__dirname, '../src/locales');

// This script is run locally — it can use a direct API key
const API_KEY = process.env.ANTHROPIC_API_KEY;

if (!API_KEY) {
  console.error('Set ANTHROPIC_API_KEY environment variable');
  process.exit(1);
}

const TRANSLATION_PROMPT = `Translate this game text from English to French.
Context: WWII tactical text game, D-Day, 101st Airborne.
Tone: Terse, military, immersive. Short sentences.
Keep in English: soldier names, ranks (SSgt, Sgt, Cpl, PFC, Pvt), weapon names (BAR, MG-42), acronyms (OPORD, DZ, PIR, KIA), locations.
Use "vous" (formal second person) for the player.
Return ONLY the French translation, no explanations.`;

async function translateText(text: string): Promise<string> {
  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': API_KEY!,
      'anthropic-version': '2023-06-01',
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 1024,
      system: TRANSLATION_PROMPT,
      messages: [{ role: 'user', content: text }],
    }),
  });

  const data = await response.json();
  return data.content[0].text;
}

// Main logic: read en files, find missing fr keys, translate, write
async function main() {
  const targetFile = process.argv[2]; // optional: specific file to translate
  // ... implementation reads en/ files, generates fr/ drafts
  // Details left to implementer — the pattern is clear
}

main().catch(console.error);
```

**Step 2: Add npm script**

```json
"i18n:draft": "npx tsx scripts/translate-draft.ts"
```

**Step 3: Test locally**

```bash
cd normandy-1944 && ANTHROPIC_API_KEY=your-key npm run i18n:draft -- ui.json
```

**Step 4: Commit**

```bash
git add -A && git commit -m "feat(i18n): add translation draft generation script"
```

---

## Task 11: Locale Key Validation Tests

**Files:**
- Create: `normandy-1944/tests/i18n/locale-validation.test.ts`
- Modify: `normandy-1944/tests/content/validation.test.ts` (extend)

**Step 1: Write locale key validation tests**

Create `tests/i18n/locale-validation.test.ts`:

```typescript
import { describe, it, expect } from 'vitest';
import * as fs from 'fs';
import * as path from 'path';

const LOCALES_DIR = path.resolve(__dirname, '../../src/locales');

function loadJson(filePath: string): Record<string, unknown> {
  return JSON.parse(fs.readFileSync(filePath, 'utf-8'));
}

function flatKeys(obj: Record<string, unknown>, prefix = ''): string[] {
  const keys: string[] = [];
  for (const [key, value] of Object.entries(obj)) {
    const fullKey = prefix ? `${prefix}.${key}` : key;
    if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
      keys.push(...flatKeys(value as Record<string, unknown>, fullKey));
    } else {
      keys.push(fullKey);
    }
  }
  return keys;
}

describe('locale file structure', () => {
  const enDir = path.join(LOCALES_DIR, 'en');
  const frDir = path.join(LOCALES_DIR, 'fr');

  it('every English key exists in French files (structure parity)', () => {
    const enUi = loadJson(path.join(enDir, 'ui.json'));
    const frUi = loadJson(path.join(frDir, 'ui.json'));
    const enKeys = flatKeys(enUi);
    const frKeys = flatKeys(frUi);
    const missing = enKeys.filter(k => !frKeys.includes(k));
    expect(missing).toEqual([]);
  });

  it('no empty English strings', () => {
    const enUi = loadJson(path.join(enDir, 'ui.json'));
    const enKeys = flatKeys(enUi);
    const empties = enKeys.filter(k => {
      const value = k.split('.').reduce((obj: any, key) => obj?.[key], enUi);
      return typeof value === 'string' && value.trim() === '';
    });
    expect(empties).toEqual([]);
  });
});

describe('scene locale files match scene definitions', () => {
  it('every scene decision ID has a matching locale key', () => {
    // Import scene registry, check each scene's decision IDs
    // against the scene locale JSON keys
    // This ensures no key drift
  });
});
```

**Step 2: Run tests**

```bash
cd normandy-1944 && npx vitest run tests/i18n/
```

**Step 3: Commit**

```bash
git add -A && git commit -m "test(i18n): add locale key validation and structure parity tests"
```

---

## Task 12: Generate French Translation Drafts

**Files:**
- Modify: All `normandy-1944/src/locales/fr/*.json` files

**Step 1: Generate drafts**

```bash
cd normandy-1944 && ANTHROPIC_API_KEY=your-key npm run i18n:draft
```

This populates all French locale files with LLM-generated translations.

**Step 2: Check status**

```bash
npm run i18n:status
```

Expected: Most files at 100% (draft coverage).

**Step 3: Manual review**

Open each `fr/*.json` file in Cursor alongside its `en/*.json` counterpart. Review and polish the French text. Priority order:

1. `fr/ui.json` — most visible, smallest
2. `fr/game.json` — status labels
3. `fr/orders.json` — battle orders
4. `fr/achievements.json` — achievement text
5. `fr/secondInCommand.json` — 2IC comments
6. `fr/scenes/*.json` — narrative content (largest effort)
7. `fr/soldiers.json` — backgrounds and epilogues

**Step 4: Commit**

```bash
git add -A && git commit -m "feat(i18n): add French translation drafts for all locale files"
```

---

## Task 13: Final Verification

**Step 1: Run all tests**

```bash
cd normandy-1944 && npx vitest run
```

All tests must pass.

**Step 2: Manual browser test**

```bash
cd normandy-1944 && npm run dev
```

- Open the game
- Verify language selector appears on main menu
- Select "Français" — all UI text switches to French
- Start a game — narrative shows in French (or English fallback if not yet translated)
- Status panel shows French labels (Hommes, Munitions, Moral, Ennemi)
- Open Orders panel — French battle orders
- Open Roster panel — French headers, English soldier names
- Switch back to English — everything reverts
- Refresh page — language choice persists

**Step 3: Commit final state**

```bash
git add -A && git commit -m "feat(i18n): complete FR/EN language support"
```
